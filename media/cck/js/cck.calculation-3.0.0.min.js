/*
 * jQuery Calculation Plug-in * Copyright (c) 2011 Dan G. Switzer, II Dual licensed under the MIT and GPL licenses: * http://www.opensource.org/licenses/mit-license.php * http://www.gnu.org/licenses/gpl.html
 * Modified for SEBLOD (App Builder & CCK) // SEBLOD nano (Form Builder).
 */
(function($){var defaults={formatNumber:0,sepDecimals:".",sepThousands:",",reChars:/([a-zA-Z0-9\ \-_])*/g,reNumbers:/(-?\$?)(\d+(,\d{3})*(\.\d{1,})?|\.\d{1,})/g,cleanseNumber:function(a){return a.replace(/[^0-9.\-]/g,"")},useFieldPlugin:!!$.fn.getValue,onParseError:null,onParseClear:null};$.Calculation={version:"0.4.09",setDefaults:function(a){$.extend(defaults,a)}};$.fn.parseChar=function(a,b){var c=[];b=$.extend(b,defaults);this.each(function(d){if(a[d]){var e=$(this);if(e.is("select")){var f=$.trim(e.find("option:selected").attr(a[d])).match(defaults.reChars,"")}else if(e.is("fieldset")){var f=$.trim(e.find("input:checked").attr(a[d])).match(defaults.reChars,"")}else{var f=$.trim(e.attr(a[d])).match(defaults.reChars,"")}if(f==null){f=""}else{f=f.toString().replace(",","")}}else{var e=$(this),g=e.is(":input")?defaults.useFieldPlugin?"getValue":"val":e.is("fieldset")?"myVal":"text",f=$.trim(e[g]()).match(defaults.reChars,"");if(f==null){f="";if(jQuery.isFunction(b.onParseError))b.onParseError.apply(e,[g]);$.data(e[0],"calcParseError",true)}else{f=f[0];if($.data(e[0],"calcParseError")&&jQuery.isFunction(b.onParseClear)){b.onParseClear.apply(e,[g]);$.data(e[0],"calcParseError",false)}}}c.push(f)});return c};$.fn.parseNumber=function(a,b){var c=[];b=$.extend(b,defaults);this.each(function(d){if(a[d]){var e=$(this);if(e.is("select")){var f=$.trim(e.find("option:selected").attr(a[d])).match(defaults.reNumbers,"")}else if(e.is("fieldset")){var f=0;var g=0;e.find("input:checked").each(function(){g=$(this).attr(a[d]);if(g){f=f+parseInt(g)}});f=$.trim(f).match(defaults.reNumbers,"")}else{var f=$.trim(e.attr(a[d])).match(defaults.reNumbers,"")}if(f==null){f=0}}else{var e=$(this);if(e.is("fieldset")){sMethod="myVal";var f=e[sMethod]();if(f){var h=f.split(",");var i=h.length;if(i>1){f=0;for(var j=0;j<i;j++){if(h[j]){f=f+parseInt(h[j])}}}}f=$.trim(f).match(defaults.reNumbers,"")}else if(e.is(":input")){sMethod=defaults.useFieldPlugin?"getValue":"val";var f=$.trim(e[sMethod]()).match(defaults.reNumbers,"")}else{sMethod="text";var f=$.trim(e[sMethod]()).match(defaults.reNumbers,"")}if(f==null){f=0;if(jQuery.isFunction(b.onParseError))b.onParseError.apply(e,[sMethod]);$.data(e[0],"calcParseError",true)}else{f=b.cleanseNumber.apply(this,[f[0]]);if($.data(e[0],"calcParseError")&&jQuery.isFunction(b.onParseClear)){b.onParseClear.apply(e,[sMethod]);$.data(e[0],"calcParseError",false)}}}c.push(parseFloat(f,10))});return c};$.fn.calc=function(expr,vars,targets,cbFormat,cbDone){var $this=this,exprValue="",precision=0,$el,$el2,parsedVars={},tmp,sMethod,target=[],_,bIsError=false;var i=0;for(var k in vars){expr=expr.replace(new RegExp("("+k+")","g"),"_.$1");if(!!vars[k]&&!!vars[k].jquery){target[0]=targets[i];parsedVars[k]=vars[k].parseNumber(target)}else{parsedVars[k]=vars[k]}i++}this.each(function(i,el,el2){var p,len,v;$el=$(this);$el2=$("#_"+$(this).attr("id"));sMethod=$el.is(":input")?defaults.useFieldPlugin?"setValue":"val":$el.is("fieldset")?"myVal":"text";_={};for(var k in parsedVars){if(typeof parsedVars[k]=="number"){_[k]=parsedVars[k]}else if(typeof parsedVars[k]=="string"){_[k]=parseFloat(parsedVars[k],10)}else if(!!parsedVars[k]&&parsedVars[k]instanceof Array){tmp=parsedVars[k].length==$this.length?i:0;_[k]=parsedVars[k][tmp]}if(isNaN(_[k]))_[k]=0;p=_[k].toString().match(/\.\d+$/gi);len=p?p[0].length-1:0;if(len>precision)precision=len}try{exprValue=eval(expr);if(precision)exprValue=Number(exprValue.toFixed(Math.max(precision,4)));if(jQuery.isFunction(cbFormat)){var tmp=cbFormat.apply(this,[exprValue]);if(!!tmp)exprValue=tmp}}catch(e){exprValue=e;bIsError=true}v=exprValue.toString();if(defaults.formatNumber){v=formatNumber(v,defaults.sepDecimals,defaults.sepThousands)}$el[sMethod](v);if($el2.length){sMethod=$el2.is(":input")?defaults.useFieldPlugin?"setValue":"val":"text";$el2[sMethod](v)}});if(jQuery.isFunction(cbDone))cbDone.apply(this,[this]);return this};$.each(["sum","product","concatenate","avg","count","max","min"],function(a,b){$.fn[b]=function(a,c,d){var d=d||[];if(arguments.length==0)return math[b](this.parseNumber());var e=c&&c.constructor==Object&&!(c instanceof jQuery);var f=a&&a.constructor==Object?a:{bind:a||"keyup",selector:!e?c:null,selector2:"",oncalc:null};if(e)f=jQuery.extend(f,c);if(!!f.selector)f.selector=$(f.selector);f.selector2=$("#_"+f.selector.attr("id"));var g=b=="concatenate"?"parseChar":"parseNumber";var h="";var i=this,j,k=function(){var a=math[b](i[g](d,f));var c=a.toString();if(defaults.formatNumber){c=formatNumber(c,defaults.sepDecimals,defaults.sepThousands)}if(!!f.selector){j=f.selector.is(":input")?defaults.useFieldPlugin?"setValue":"val":"text";f.selector[j](c)}if(f.selector2.length){j=f.selector2.is(":input")?defaults.useFieldPlugin?"setValue":"val":"text";f.selector2[j](c)}if(jQuery.isFunction(f.oncalc))f.oncalc.apply(i,[a,f])};k();if(f.bind!="none"){return i.bind(f.bind,k)}return}});var math={sum:function(a){var b=0,c=0;$.each(a,function(a,d){var e=d.toString().match(/\.\d+$/gi),f=e?e[0].length-1:0;if(f>c)c=f;b+=d});if(c)b=Number(b.toFixed(c));return b},product:function(a){var b=1,c=0;$.each(a,function(a,d){var e=d.toString().match(/\.\d+$/gi),f=e?e[0].length-1:0;if(f>c)c=f;b=b*d});if(c)b=Number(b.toFixed(c));return b},concatenate:function(a){var b="";$.each(a,function(a,c){b+=c});return b},avg:function(a){return math.sum(a)/a.length},count:function(a){return a.length},max:function(a){return Math.max.apply(Math,a)},min:function(a){return Math.min.apply(Math,a)}};$.fn.format=function(a,b,c){var c=c||[];if(arguments.length==0)return this.val();var d=b&&b.constructor==Object&&!(b instanceof jQuery);var e=a&&a.constructor==Object?a:{bind:a||"keyup",selector:!d?b:null,selector2:"",oncalc:null};if(d)e=jQuery.extend(e,b);if(!!e.selector)e.selector=$(e.selector);e.selector2=$("#_"+e.selector.attr("id"));var f="";var g="";var h=this,i=function(){var a=new RegExp("\\"+defaults.sepThousands,"g");var b=e.selector.val().replace(a,"");var c=formatNumber(b.toString(),defaults.sepDecimals,defaults.sepThousands);if(!!e.selector){e.selector.val(c)}if(e.selector2.length){e.selector2.val(c)}if(jQuery.isFunction(e.oncalc))e.oncalc.apply(h,[b,e])};i();if(e.bind!="none"){return h.bind(e.bind,i)}return};var formatNumber=function(a,b,c){a+="";x=a.split(".");x1=x[0];x2=x.length>1?b+x[1]:"";var d=/(\d+)(\d{3})/;while(d.test(x1)){x1=x1.replace(d,"$1"+c+"$2")}return x1+x2}})(jQuery)